<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Market Researcher</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 1200px; margin: 2rem auto; padding: 0 1rem; background-color: #f9f9f9; }
        h1 { color: #333; }
        .controls-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
        .input-group { display: flex; flex-direction: column; flex: 1; min-width: 200px; }
        label { font-size: 0.85rem; color: #666; margin-bottom: 5px; font-weight: bold; }
        input[type="text"] { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }
        
        .main-layout { display: flex; gap: 20px; margin-top: 20px; align-items: flex-start; }
        .table-area { flex: 1; min-width: 0; }
        .preview-area { flex: 1; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden; position: sticky; top: 20px; height: 80vh; display: flex; flex-direction: column; }
        .preview-header { padding: 10px; background: #f4f4f4; border-bottom: 1px solid #ddd; font-weight: bold; font-size: 0.9rem; }
        .preview-content { padding: 20px; overflow-y: auto; flex: 1; }
        
        /* App Card Styles */
        .app-card { display: flex; flex-direction: column; gap: 15px; }
        .app-card-header { display: flex; gap: 15px; align-items: flex-start; }
        .app-card-icon { width: 80px; height: 80px; border-radius: 16px; object-fit: cover; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .app-card-info { flex: 1; }
        .app-card-title { font-size: 1.25rem; font-weight: bold; margin: 0; color: #333; }
        .app-card-dev { font-size: 0.9rem; color: #666; margin: 2px 0; }
        .app-card-stats { display: flex; gap: 15px; margin-top: 8px; font-size: 0.85rem; color: #444; }
        .app-card-rating { display: flex; align-items: center; gap: 4px; color: #ffa000; font-weight: bold; }
        
        .app-card-screenshots { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-top: 10px; }
        .app-card-screenshots img { height: 200px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
        
        .app-card-description { font-size: 0.9rem; line-height: 1.5; color: #555; border-top: 1px solid #eee; padding-top: 15px; }
        .btn-view-store { display: inline-block; margin-top: 15px; padding: 10px 15px; background: #007bff; color: white; text-decoration: none; border-radius: 4px; font-weight: bold; text-align: center; }

        /* Toggle Switch Style */
        .toggle-container { display: flex; align-items: center; gap: 10px; margin-top: 10px;}
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2196F3; }
        input:checked + .slider:before { transform: translateX(26px); }

        button#searchBtn { padding: 12px 24px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; font-weight: bold; height: fit-content; align-self: flex-end; }
        button#searchBtn:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #eee; padding: 12px; text-align: left; }
        th { background-color: #f4f4f4; color: #333; }
        .valid { color: #28a745; font-weight: bold; }
        .invalid { color: #dc3545; font-weight: bold; }
        
        #loading { display: none; text-align: center; margin: 20px; font-style: italic; color: #666; }
        .actions { margin-top: 20px; text-align: right; }
        .btn-export { background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }

        .export-config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-top: 20px; text-align: left; }
        .export-config-grid .input-group { min-width: unset; }
        .export-config-grid label { font-size: 0.75rem; }
        .export-config-grid input { padding: 8px; font-size: 0.9rem; }

        /* Tooltip Styles */
        .tooltip { position: relative; display: inline-block; cursor: help; margin-left: 4px; color: #007bff; font-weight: bold; }
        .tooltip .tooltiptext { visibility: hidden; width: 200px; background-color: #333; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 100; bottom: 125%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.2s; font-weight: normal; font-size: 0.75rem; line-height: 1.4; box-shadow: 0 4px 12px rgba(0,0,0,0.15); pointer-events: none; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .tooltip .tooltiptext::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #333 transparent transparent transparent; }
    </style>
</head>
<body>

    <h1>üì± App Market Researcher</h1>
    
    <div class="controls-container">
        <div class="input-group">
            <label for="topic">Topic</label>
            <input type="text" id="topic" placeholder="e.g., 'Cycling Apps', 'Budget Tracking'">
        </div>
        <div class="input-group">
            <label for="region">Region</label>
            <input type="text" id="region" placeholder="e.g., 'Singapore', 'US'" value="">
        </div>
        
        <!-- NEW: API Key and Model Selection -->
        <div class="input-group">
            <label for="apiKey">Gemini API Key</label>
            <input type="password" id="apiKey" placeholder="AIzaSy...">
        </div>
        <div class="input-group">
            <label for="modelName">Gemini Model <a href="#" onclick="refreshModels(); return false;" style="font-size: 0.7rem; margin-left: 5px; color: #007bff; text-decoration: none;">(Refresh List)</a></label>
            <select id="modelName" style="padding: 10px; border-radius: 4px; border: 1px solid #ccc;">
                <option value="gemini-3-pro-preview">gemini-3-pro-preview (Reasoning)</option>
                <option value="gemini-3-flash-preview">gemini-3-flash-preview (Reasoning)</option>
            </select>
        </div>

        <div class="input-group" style="flex: 0 0 auto;">
            <label>AI Package Resolve</label>
            <div class="toggle-container">
                <label class="switch">
                    <input type="checkbox" id="aiResolve">
                    <span class="slider"></span>
                </label>
                <span style="font-size: 0.8rem; color: #555;">(Slower)</span>
            </div>
        </div>

        <button onclick="performSearch()" id="searchBtn">Search</button>
    </div>

    <div id="loading">
        üß† <b>Researching...</b><br>
        <small>If AI Resolve is on, this may take a minute.</small>
    </div>

    <div class="main-layout" id="mainLayout" style="display:none;">
        <div class="table-area">
            <table id="resultsTable">
                <thead>
                    <tr>
                        <th style="width: 50px;">Select</th>
                        <th>App Name</th>
                        <th>Package ID</th>
                        <th style="width: 80px;">Weight</th>
                        <th>Status</th>
                        <th>Play Store</th>
                    </tr>
                </thead>
                <tbody id="resultsBody"></tbody>
            </table>

            <div style="margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px;">
                <h3 style="color: #333; margin-bottom: 10px;">üì¶ Export Configuration</h3>
                <p style="font-size: 0.85rem; color: #666; margin-bottom: 15px;">Customize the metadata fields for the final JSON output.</p>
                <div class="export-config-grid" id="exportConfig" style="display:none;">
                    <div class="input-group">
                        <label for="groupKey">Category</label>
                        <input type="text" id="groupKey" value="" placeholder="e.g. StreamingApps">
                    </div>
                    <div class="input-group">
                        <label for="exportCount">count threshold <span class="tooltip">‚ìò<span class="tooltiptext">The minimum number of installed apps required for the category to be considered active.</span></span></label>
                        <input type="number" id="exportCount" value="1">
                    </div>
                    <div class="input-group">
                        <label for="exportThreshold">weight threshold <span class="tooltip">‚ìò<span class="tooltiptext">The minimum cumulative weight required for the category to be considered active.</span></span></label>
                        <input type="number" id="exportThreshold" step="0.1" value="1.0">
                    </div>
                    <div class="input-group">
                        <label for="exportMsName">MS Name <span class="tooltip">‚ìò<span class="tooltiptext">The name of the microsegment</span></span></label>
                        <input type="text" id="exportMsName" value="">
                    </div>
                    <div class="input-group">
                        <label for="exportListName">List Name (If List) <span class="tooltip">‚ìò<span class="tooltiptext">The name for the list microsegment</span></span></label>
                        <input type="text" id="exportListName" value="">
                    </div>
                    <div class="input-group" style="flex: 0 0 auto; justify-content: center;">
                        <label>isList</label>
                        <div class="toggle-container" style="margin-top: 0;">
                            <label class="switch" style="width: 40px; height: 20px;">
                                <input type="checkbox" id="exportIsList" checked onchange="toggleListName(this.checked)">
                                <span class="slider" style="border-radius: 20px;"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="actions" id="exportSection">
                <button onclick="addNewRow()" style="background-color: #6c757d; margin-right: 10px;" class="btn-export">‚ûï Add App Manually</button>
                <button onclick="exportJson()" class="btn-export">‚¨áÔ∏è Export Selected to JSON</button>
            </div>
        </div>

        <div class="preview-area" id="previewArea">
            <div class="preview-header">App Preview</div>
            <div id="previewContent" class="preview-content">
                <p style="color: #666; text-align: center; margin-top: 50px;">Select an app to see details</p>
            </div>
        </div>
    </div>

    <script>
        let currentResults = [];

        function addNewRow() {
            const newApp = {
                name: "New App",
                package: "",
                status: "Pending",
                play_store_url: "#",
                weight: 1.0
            };
            currentResults.push(newApp);
            
            // If table is hidden (e.g. before first search), show it
            document.getElementById('mainLayout').style.display = 'flex';
            document.getElementById('exportConfig').style.display = 'grid';
            
            renderTable(currentResults);
        }

        // Initialize with saved values
        window.onload = () => {
            const savedKey = localStorage.getItem('geminiApiKey');
            if(savedKey) {
                document.getElementById('apiKey').value = savedKey;
            }
            if(localStorage.getItem('geminiModel')) {
                document.getElementById('modelName').value = localStorage.getItem('geminiModel');
            }
        };

        async function refreshModels() {
            const apiKey = document.getElementById('apiKey').value;
            if(!apiKey) return alert("Please enter an API Key first to list models.");
            
            try {
                const response = await fetch(`/api/models?api_key=${apiKey}`);
                if(!response.ok) throw new Error("Failed to fetch models");
                const data = await response.json();
                
                if(!data.models || data.models.length === 0) {
                    alert("No models found for this API key. The list was not updated.");
                    return;
                }
                
                const select = document.getElementById('modelName');
                const currentValue = select.value;
                select.innerHTML = '';
                
                data.models.forEach(m => {
                    const opt = document.createElement('option');
                    // Remove "models/" prefix for cleaner UI and to match expected SDK input
                    const shortName = m.replace('models/', '');
                    opt.value = shortName;
                    opt.innerText = shortName;
                    select.appendChild(opt);
                });
                
                // Try to restore previous value
                select.value = currentValue;
                alert("Model list updated from API!");
            } catch (e) {
                alert("Error fetching models: " + e.message);
            }
        }

        async function performSearch() {
            const topic = document.getElementById('topic').value;
            const region = document.getElementById('region').value;
            const resolveWithAi = document.getElementById('aiResolve').checked;
            const apiKey = document.getElementById('apiKey').value;
            const modelName = document.getElementById('modelName').value;
            
            if(!topic) return alert("Please enter a topic");
            if(!apiKey) return alert("Please enter your Gemini API Key");

            // Save for convenience
            localStorage.setItem('geminiApiKey', apiKey);
            localStorage.setItem('geminiModel', modelName);

            // UI State: Loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('mainLayout').style.display = 'none';
            document.getElementById('searchBtn').disabled = true;
            document.getElementById('searchBtn').innerText = "Searching...";

            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        topic: topic, 
                        region: region, 
                        resolve_pkg_with_ai: resolveWithAi,
                        api_key: apiKey,
                        model_name: modelName
                    })
                });
                
                if (!response.ok) throw new Error("Server error");
                
                const data = await response.json();
                currentResults = data.data;
                renderTable(currentResults);
            } catch (error) {
                alert("Error: " + error.message);
            } finally {
                // UI State: Finished
                document.getElementById('loading').style.display = 'none';
                document.getElementById('searchBtn').disabled = false;
                document.getElementById('searchBtn').innerText = "Search";
            }
        }

        function renderTable(apps) {
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';
            
            if (apps.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No apps found.</td></tr>';
                document.getElementById('mainLayout').style.display = 'flex';
                document.getElementById('exportConfig').style.display = 'none';
                return;
            }

            apps.forEach((app, index) => {
                const tr = document.createElement('tr');
                tr.id = `row-${index}`;
                const isVerified = app.status === 'Verified';
                
                // Only verify apps are checked by default
                const checkedAttr = isVerified ? 'checked' : '';
                const statusClass = isVerified ? 'valid' : 'invalid';
                const linkLabel = isVerified ? 'View' : 'Search';
                const linkHtml = `<a id="link-${index}" href="#" onclick="showAppPreview(currentResults[${index}].package, ${index}); return false;">${linkLabel}</a>`;

                tr.innerHTML = `
                    <td style="text-align:center;">
                        <input type="checkbox" class="app-checkbox" data-index="${index}" ${checkedAttr}>
                    </td>
                    <td><input type="text" value="${app.name}" style="width:100%; border:none; background:transparent;" onchange="updateName(${index}, this.value)"></td>
                    <td><input type="text" value="${app.package}" style="width:100%; border:none; background:transparent;" onchange="updatePackage(${index}, this.value)"></td>
                    <td><input type="number" step="0.1" value="${app.weight || 1.0}" style="width:60px; border:none; background:transparent;" onchange="updateWeight(${index}, this.value)"></td>
                    <td id="status-${index}" class="${statusClass}">${app.status}</td>
                    <td>${linkHtml}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('mainLayout').style.display = 'flex';
            document.getElementById('exportConfig').style.display = 'grid';
        }

        async function showAppPreview(packageId, index) {
            const content = document.getElementById('previewContent');
            if (!packageId) {
                content.innerHTML = `<p style="color: #dc3545; text-align: center; margin-top: 50px;">No package ID provided</p>`;
                return;
            }

            content.innerHTML = `<p style="text-align: center; margin-top: 50px;">‚åõ Loading details for ${packageId}...</p>`;

            try {
                const response = await fetch(`/api/app-details?package_id=${packageId}`);
                if (!response.ok) throw new Error("App not found or Store error");
                const app = await response.json();

                content.innerHTML = `
                    <div class="app-card">
                        <div class="app-card-header">
                            <img src="${app.icon}" class="app-card-icon" onerror="this.src='https://play-lh.googleusercontent.com/Vf96sh_t9S_76092019-3829-192-3829-192-3829-192-3829/icon-192x192.png'">
                            <div class="app-card-info">
                                <h2 class="app-card-title">${app.title}</h2>
                                <p class="app-card-dev">${app.developer}</p>
                                <div class="app-card-stats">
                                    <span class="app-card-rating">‚òÖ ${app.scoreText || 'N/A'}</span>
                                    <span>${app.installs || '0+'} installs</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="app-card-screenshots">
                            ${(app.screenshots || []).map(src => `<img src="${src}" onclick="window.open('${src}', '_blank')">`).join('')}
                        </div>

                        <div class="app-card-description">
                            ${app.descriptionHTML || app.description || 'No description available.'}
                        </div>

                        <a href="https://play.google.com/store/apps/details?id=${packageId}" target="_blank" class="btn-view-store">Open in Play Store ‚Üó</a>
                    </div>
                `;
            } catch (e) {
                const appName = currentResults[index] ? currentResults[index].name : "this app";
                content.innerHTML = `
                    <div style="text-align: center; margin-top: 50px;">
                        <h3 style="color: #dc3545;">Preview Unavailable</h3>
                        <p>We couldn't find a validated app with the package ID: <br><code>${packageId || 'none'}</code></p>
                        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
                        <p>Try searching for <b>"${appName}"</b> on the Play Store:</p>
                        <a href="https://play.google.com/store/search?q=${encodeURIComponent(appName)}&c=apps" target="_blank" class="btn-view-store">Search Play Store ‚Üó</a>
                        <p style="margin-top: 20px;"><small>Tip: Once you find the correct package ID, you can edit it in the table to verify it.</small></p>
                    </div>
                `;
            }
        }

        function updateName(index, newValue) {
            currentResults[index].name = newValue;
        }

        function updateWeight(index, newValue) {
            currentResults[index].weight = parseFloat(newValue) || 1.0;
        }

        async function updatePackage(index, newValue) {
            currentResults[index].package = newValue;
            const statusCell = document.getElementById(`status-${index}`);
            const linkElement = document.getElementById(`link-${index}`);
            
            statusCell.innerText = "Checking...";
            statusCell.className = "";

            try {
                const appName = currentResults[index].name;
                const response = await fetch(`/api/verify?package_name=${newValue}&app_name=${encodeURIComponent(appName)}`);
                const data = await response.json();
                
                currentResults[index].status = data.status;
                currentResults[index].play_store_url = data.play_store_url;

                statusCell.innerText = data.status;
                statusCell.className = data.status === 'Verified' ? 'valid' : 'invalid';
                
                linkElement.href = "#";
                linkElement.innerText = data.status === 'Verified' ? 'View' : 'Search';
                linkElement.onclick = () => {
                    showAppPreview(currentResults[index].package, index);
                    return false;
                };
            } catch (e) {
                console.error("Verification error", e);
                statusCell.innerText = "Error";
            }
        }

        function toggleListName(checked) {
            document.getElementById('exportListName').disabled = !checked;
            document.getElementById('exportListName').style.opacity = checked ? '1' : '0.5';
        }

        function exportJson() {
            const groupKey = document.getElementById('groupKey').value || "ExportedApps";
            const count = parseInt(document.getElementById('exportCount').value) || 0;
            const threshold = parseFloat(document.getElementById('exportThreshold').value) || 0.0;
            const isList = document.getElementById('exportIsList').checked ? 1 : 0;
            const msName = document.getElementById('exportMsName').value;
            const listName = document.getElementById('exportListName').value;

            const checkboxes = document.querySelectorAll('.app-checkbox:checked');
            const selectedApps = Array.from(checkboxes).map(cb => {
                const index = cb.getAttribute('data-index');
                return {
                    package: currentResults[index].package,
                    name: currentResults[index].name,
                    weight: parseFloat(currentResults[index].weight) || 1.0
                };
            });

            if(selectedApps.length === 0) return alert("No apps selected!");

            const groupData = {
                "count": count,
                "threshold": threshold,
                "isList": isList,
                "msName": msName
            };

            if (isList) {
                groupData["listName"] = listName;
            }

            groupData["list"] = selectedApps;

            const finalOutput = {
                [groupKey]: groupData
            };

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(finalOutput, null, 2));
            const downloadAnchorNode = document.createElement('a');
            
            downloadAnchorNode.setAttribute("href",     dataStr);
            downloadAnchorNode.setAttribute("download", groupKey + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
    </script>
</body>
</html>